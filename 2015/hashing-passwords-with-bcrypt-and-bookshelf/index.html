<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Evan Hackett - Hashing Passwords with bcrypt and Storing Them with Bookshelf.js Using Promises</title>
  <link rel="shortcut icon" href="/assets/images/favicon.ico">
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="alternate" type="application/rss+xml" title="My Blog" href="/feed.xml">
  <link rel="stylesheet" href="/assets/css/highlight.css">

  <!-- mathjax -->
  <script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<!-- fontawesome -->
<script src="https://use.fontawesome.com/f92380e0dd.js"></script>
</head>
<body>

  <nav class="main-nav">
    
        <a href="/"> <span class="arrow">←</span> Home </a>
    

    
        
            <a href="/about">About </a>
        
    
    <a class="cta" href="/feed.xml">Subscribe</a>
</nav>


  

  <section id="wrapper" class="">
    <article class="post">
    <header>
        <h1>Hashing Passwords with bcrypt and Storing Them with Bookshelf.js Using Promises</h1>
        <h2 class="headline">September 15, 2015</h2>
    </header>
    <section id="post-body">
        <p>I recently ran into some issues trying to store passwords using the bookshelf ORM after asynchronously hashing them with bcrypt. I’m writing this post to potentially help others who might have this issue in the future, but also so I have a link for myself to refer to in case I ever have this issue again.</p>

<p>First a little background to explain the situation. I was working on an express app, using bookshelf.js as my ORM, and I was trying to hash the passwords for my user models before storing them in the database. Lets take a look at the original implementation:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../config'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">bcrypt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bcrypt-nodejs'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="na">tableName</span><span class="p">:</span> <span class="s1">'users'</span><span class="p">,</span>
  <span class="na">hasTimestamps</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">initialize</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'creating'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'password'</span><span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Error in hash creation: '</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'password'</span><span class="p">,</span> <span class="nx">hash</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">User</span><span class="p">;</span></code></pre></figure>

<p>I have chosen to use the asynchronous version of bcrypt’s hash function because I don’t want my server to be rendered completely useless under a heavy load. After all, bcrypt  is designed to be slow (to make it difficult to brute force the password). Given that I am using the asynchronous version, I attempt to set the password on the user model inside of the callback to bcrypt.hash. What is wrong with this code?</p>

<p>Lets walk through the sequence of events. First I might create a new User somewhere else in my application:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">bob</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">({</span><span class="na">username</span><span class="p">:</span> <span class="s1">'bob'</span><span class="p">,</span> <span class="na">password</span><span class="p">:</span> <span class="s1">'abcd'</span><span class="p">});</span>
<span class="nx">bob</span><span class="p">.</span><span class="nx">save</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// do stuff</span>
<span class="p">});</span> </code></pre></figure>

<p>After calling .save(), a “creating” event is fired. This will trigger our creating handler inside of the initialize function of the user model. The idea is this handler will be invoked before anything is saved to the database. So we should end up storing the hashed password right? Wrong. The way Bookshelf works is it will wait for the creating event to return a value before saving anything into the database. Once a value is returned from the creating handler, the model is signaled to save data to the database. Since the creating handler returns undefined in this case, that still signals to the model that it is free to save to the DB. At some point later, the callback to bcrypt.hash will execute, and in that scope we will set the model’s password to be the hashed password (but the database will have the plaintext password). </p>

<p>Before giving up and using the synchronous version of bcrypt’s hash, there is another way! We can use promises! If the creating handler returns a promise, it won’t signal to the model to save  to the DB until the promise resolves. Let’s refactor our user model to a promise implementation using the Bluebird promise library.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../config'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">bcrypt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bcrypt-nodejs'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bluebird'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="na">tableName</span><span class="p">:</span> <span class="s1">'users'</span><span class="p">,</span>
  <span class="na">hasTimestamps</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">initialize</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'creating'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">promiseHash</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisify</span><span class="p">(</span><span class="nx">bcrypt</span><span class="p">.</span><span class="nx">hash</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">promiseHash</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'password'</span><span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'password'</span><span class="p">,</span> <span class="nx">hash</span><span class="p">);</span>
        <span class="p">});</span> 
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">User</span><span class="p">;</span></code></pre></figure>

<p>As you can see, our creating handler now returns a promise (using a promisified version of bcrypt.hash). Once the promise is resolved (after setting the password in our model to the hashed password) the model is then signaled that it is free to write to the database. We have successfully achieved our goal of asynchronous password hashing within the initialization of a Bookshelf model!</p>

    </section>
</article>
<footer id="post-meta" class="clearfix">
    <a href="/">
        <img class="avatar" src="/assets/images/avatar.jpg">
        <div>
            <span class="dark">Evan Hackett</span>
            <span>My blog. Mainly Computer Science stuff.</span>
        </div>
    </a>

    <section id="sharing">
        <a href="https://github.com/evanhackett"><img src="/assets/images/GitHub-Mark-32px.png" alt="github-logo" /></a>
<a href="mailto:evanwhackett@gmail.com"><i class="fa fa-envelope fa-2x" aria-hidden="true"></i></a>

    </section>
</footer>

<!-- Disqus comments -->


<!-- Archive post list -->


  </section>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="/assets/js/main.js"></script>
  <script src="/assets/js/highlight.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-XXXXXXXX-X', 'auto');
    ga('send', 'pageview');
  </script>
</body>
</html>
